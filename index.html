<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dazibao</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 0;
                padding: 0;
            }
            .header {
                display: flex;
                justify-content: center; /* Center content horizontally */
                align-items: center;
                padding: 10px 20px;
                background-color: #f0f0f0; /* Default header background */
            }
            .header img {
                height: 40px;
                /* No margin-right here, as text will be in a separate flex item */
            }
            .header-text-wrapper { /* New wrapper for text */
                display: flex;
                flex-direction: column;
                align-items: flex-start; /* Align text to the left within its wrapper */
                margin-left: 15px; /* Space between icon and text */
            }
            .header-text { /* This class is now redundant, but keeping for now */
                /* flex-grow: 1; */ /* Removed */
                /* text-align: center; */ /* Removed */
            }
            #version-text {
                margin-bottom: 2px; /* Reduced space below version text */
                margin-top: 0; /* Remove top margin */
            }
            #last-updated-text {
                margin-top: 0; /* Remove top margin */
            }
            .container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .block {
                border-radius: 5px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .block-title {
                margin-top: 0;
                padding: 5px 10px;
                border-radius: 3px;
                font-size: 1.2em;
                font-weight: bold;
            }
            .single-command-output {
                white-space: pre-wrap;
                word-wrap: break-word;
                padding: 10px;
                border-radius: 3px;
            }
            .group-command-item {
                display: flex;
                margin-bottom: 5px;
            }
            .group-command-label {
                flex: 0 0 150px; /* Fixed width for label */
                padding: 5px 10px;
                border-radius: 3px;
                margin-right: 10px;
                font-weight: bold;
            }
            .group-command-value {
                flex-grow: 1;
                padding: 5px 10px;
                border-radius: 3px;
                white-space: pre-wrap;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <img id="app-icon" src="/icons/dazibao.png" alt="Dazibao Icon">
            <div class="header-text-wrapper">
                <p id="version-text"></p>
                <span id="last-updated-text" style="font-size: 0.8em;"></span>
            </div>
        </div>
        <div class="container">
            <div id="blocks-container">
                <!-- Blocks will be loaded here -->
            </div>
        </div>

        <script>
            const blocksContainer = document.getElementById('blocks-container');
            const lastUpdatedText = document.getElementById('last-updated-text');
            const versionText = document.getElementById('version-text');
            const body = document.body;
            const header = document.querySelector('.header');

            async function fetchData() {
                try {
                    const response = await fetch('/data');
                    const configData = await response.json();
                    const blocks = configData.blocks;
                    console.log('Fetched blocks:', blocks);
                    const lastUpdated = new Date(configData.last_updated).toLocaleString();
                    const version = configData.version;
                    const globalColors = configData.colors || {};

                    lastUpdatedText.textContent = `Last updated at ${lastUpdated}`;
                    versionText.textContent = `Dazibao v${version}`;

                    // Apply global page background color
                    if (globalColors.page_background) {
                        body.style.backgroundColor = globalColors.page_background;
                        header.style.backgroundColor = globalColors.page_background; // Apply to header as well
                    }

                    blocksContainer.innerHTML = ''; // Clear existing content

                    blocks.forEach(block => {
                        const blockDiv = document.createElement('div');
                        blockDiv.classList.add('block');

                        // Apply block-specific background color
                        if (block.colors && block.colors.background) {
                            blockDiv.style.backgroundColor = block.colors.background;
                        } else {
                            blockDiv.style.backgroundColor = '#fff'; // Default block background
                        }

                        const title = document.createElement('h2');
                        title.classList.add('block-title');
                        title.textContent = block.title;

                        // Apply block title colors
                        if (block.colors) {
                            if (block.colors.title_color) {
                                title.style.color = block.colors.title_color;
                            }
                            if (block.colors.title_background) {
                                title.style.backgroundColor = block.colors.title_background;
                            }
                        }
                        blockDiv.appendChild(title);

                        if (block.type === 'single') {
                            const pre = document.createElement('pre');
                            pre.classList.add('single-command-output');
                            pre.textContent = block.output;
                            // Apply default background for single command output if not specified
                            if (!block.colors || !block.colors.value_background) {
                                pre.style.backgroundColor = '#eee';
                            } else {
                                pre.style.backgroundColor = block.colors.value_background;
                            }
                            if (block.colors && block.colors.value_color) {
                                pre.style.color = block.colors.value_color;
                            }
                            blockDiv.appendChild(pre);
                        } else if (block.type === 'group') {
                            block.commands.forEach(command => {
                                const itemDiv = document.createElement('div');
                                itemDiv.classList.add('group-command-item');

                                const labelSpan = document.createElement('span');
                                labelSpan.classList.add('group-command-label');
                                labelSpan.textContent = command.label + ':';
                                // Apply label colors
                                if (block.colors) {
                                    if (block.colors.label_color) {
                                        labelSpan.style.color = block.colors.label_color;
                                    }
                                    if (block.colors.label_background) {
                                        labelSpan.style.backgroundColor = block.colors.label_background;
                                    } else {
                                        labelSpan.style.backgroundColor = '#f0f0f0'; // Default label background
                                    }
                                } else {
                                    labelSpan.style.backgroundColor = '#f0f0f0'; // Default label background
                                }
                                itemDiv.appendChild(labelSpan);

                                const valueSpan = document.createElement('span');
                                valueSpan.classList.add('group-command-value');
                                valueSpan.textContent = command.output;
                                // Apply value colors
                                if (block.colors) {
                                    if (block.colors.value_color) {
                                        valueSpan.style.color = block.colors.value_color;
                                    }
                                    if (block.colors.value_background) {
                                        valueSpan.style.backgroundColor = block.colors.value_background;
                                    } else {
                                        valueSpan.style.backgroundColor = '#fff'; // Default value background
                                    }
                                } else {
                                    valueSpan.style.backgroundColor = '#fff'; // Default value background
                                }
                                itemDiv.appendChild(valueSpan);

                                blockDiv.appendChild(itemDiv);
                            });
                        }
                        blocksContainer.appendChild(blockDiv);
                    });
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Fetch data every 2 seconds
            setInterval(fetchData, 2000);

            // Initial fetch
            fetchData();
        </script>
    </body>
</html>